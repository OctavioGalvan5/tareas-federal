{% extends "base.html" %}

{% block content %}
<div class="card" style="max-width: 900px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
        <div>
            <h2 style="margin-bottom: 0.5rem;"><i class="fas fa-info-circle"></i> Detalles de la Tarea</h2>
            {% if task.last_edited_by %}
            <p style="color: var(--text-light); font-size: 0.9rem; margin: 0;">
                <i class="fas fa-history"></i> √öltima edici√≥n por <strong>{{ task.last_edited_by.full_name }}</strong>
                el {{ (task.last_edited_at|to_buenos_aires).strftime('%d/%m/%Y a las %H:%M') }}
            </p>
            {% endif %}
        </div>
        {# The button block was here and has been moved to the "Acciones" section below #}
    </div>

    <div class="form-group" style="margin-bottom: 2rem;">
        <label style="display: block; margin-bottom: 0.75rem; color: var(--text-color); font-weight: 600;"><i
                class="fas fa-bolt"></i> Acciones</label>
        <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
            {% if task.status != 'Anulado' %}
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">

                <!-- Status Actions -->
                {% if task.status == 'Pending' %}
                <button onclick="updateStatus({{ task.id }}, 'In Progress')" class="button"
                    style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                    <i class="fas fa-play"></i> Iniciar
                </button>
                {% elif task.status == 'In Progress' %}
                <span class="button" style="background: #3b82f6; cursor: default; opacity: 0.8;">
                    <i class="fas fa-spinner fa-spin"></i> En Proceso
                </span>
                <button onclick="updateStatus({{ task.id }}, 'In Review')" class="button"
                    style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <i class="fas fa-paper-plane"></i> Enviar a Revisi√≥n
                </button>
                {% elif task.status == 'In Review' %}
                <span class="button" style="background: #f59e0b; cursor: default; opacity: 0.8;">
                    <i class="fas fa-eye"></i> En Revisi√≥n
                </span>
                <button onclick="updateStatus({{ task.id }}, 'Completed')" class="button"
                    style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <i class="fas fa-check-circle"></i> Aprobar
                </button>
                {% elif task.status == 'Completed' %}
                <span class="button"
                    style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); cursor: default;">
                    <i class="fas fa-check-circle"></i> Completada
                </span>
                {% if current_user.is_admin %}
                <button onclick="updateStatus({{ task.id }}, 'Pending')" class="button" style="background: #6b7280;">
                    <i class="fas fa-undo"></i> Reabrir
                </button>
                {% endif %}
                {% elif task.status == 'Scheduled' %}
                <span class="button" style="background: #8b5cf6; cursor: default; opacity: 0.9;">
                    <i class="fas fa-calendar-alt"></i> Programada
                </span>
                <button onclick="updateStatus({{ task.id }}, 'Pending')" class="button"
                    style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                    <i class="fas fa-play"></i> Activar Ahora
                </button>
                {% endif %}

                <!-- General Actions -->
                <a href="{{ url_for('main.edit_task', task_id=task.id) }}" class="button" style="background: #2563eb;">
                    <i class="fas fa-edit"></i> Editar
                </a>
                <a href="{{ url_for('main.create_task', parent_id=task.id) }}" class="button"
                    style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                    <i class="fas fa-plus-circle"></i> Subtarea
                </a>
                {% if current_user.is_admin %}
                <button onclick="anularTask({{ task.id }})" class="button"
                    style="background-color: #dc2626; padding: 0.5rem 0.8rem;" title="Anular Tarea">
                    <i class="fas fa-ban"></i>
                </button>
                {% endif %}
            </div>
            {% else %}
            <span class="button" style="background-color: #9ca3af; cursor: not-allowed; width: 100%;">
                <i class="fas fa-ban"></i> Tarea Anulada
            </span>
            {% endif %}
        </div>
    </div>

    <div class="form-group">
        <label><i class="fas fa-heading"></i> T√≠tulo</label>
        <div
            style="padding: 0.8rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 1.1rem; font-weight: 500; {% if task.status == 'Anulado' %}text-decoration: line-through; color: #9ca3af;{% endif %}">
            {{ task.title }}
        </div>
    </div>

    <div class="form-group">
        <label><i class="fas fa-align-left"></i> Descripci√≥n</label>
        <div
            style="padding: 0.8rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; min-height: 100px; white-space: pre-wrap;">
            {{ task.description or 'Sin descripci√≥n' }}</div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
        <div class="form-group">
            <label><i class="fas fa-exclamation-circle"></i> Prioridad</label>
            <div style="padding: 0.8rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                <span class="priority-badge priority-{{ task.priority|lower }}">{{ task.priority }}</span>
            </div>
        </div>

        <div class="form-group">
            <label><i class="fas fa-tasks"></i> Estado</label>
            <div style="padding: 0.8rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                {% if task.status == 'Completed' %}
                <span style="color: #10b981; font-weight: 600;"><i class="fas fa-check-circle"></i>
                    Completado</span>
                {% elif task.status == 'In Review' %}
                <span style="color: #f59e0b; font-weight: 600;"><i class="fas fa-eye"></i>
                    En Revisi√≥n</span>
                {% elif task.status == 'In Progress' %}
                <span style="color: #3b82f6; font-weight: 600;"><i class="fas fa-spinner"></i>
                    En Proceso</span>
                {% elif task.status == 'Anulado' %}
                <span style="color: #9ca3af; font-weight: 600;"><i class="fas fa-ban"></i>
                    Anulado</span>
                {% elif task.status == 'Scheduled' %}
                <span style="color: #8b5cf6; font-weight: 600;"><i class="fas fa-calendar-alt"></i>
                    Programada</span>
                {% else %}
                <span style="color: #6b7280; font-weight: 600;"><i class="fas fa-clock"></i>
                    Pendiente</span>
                {% endif %}
            </div>
        </div>

        <div class="form-group">
            <label><i class="fas fa-building"></i> √Årea</label>
            <div style="padding: 0.8rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                {% if task.area %}
                <span
                    style="display: inline-block; padding: 0.3rem 0.8rem; background-color: #e0f2fe; color: {{ task.area.color }}; border-radius: 6px; font-weight: 600;">
                    <i class="fas fa-building"></i> {{ task.area.name }}
                </span>
                {% else %}
                <span style="color: #ef4444; font-weight: 600;"><i class="fas fa-exclamation-triangle"></i> Sin √°rea
                    asignada</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Fechas en fila separada -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
        {% if task.planned_start_date %}
        <div class="form-group"
            style="background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); padding: 1rem; border-radius: 8px; border: 1px solid #c4b5fd;">
            <label style="color: #5b21b6;"><i class="fas fa-calendar-plus"></i> Fecha/Hora de Inicio</label>
            <div
                style="padding: 0.8rem; background: white; border: 1px solid #c4b5fd; border-radius: 6px; color: #5b21b6; font-weight: 600;">
                <i class="fas fa-clock"></i> {{ task.planned_start_date.strftime('%d/%m/%Y a las %H:%M') }}
            </div>
        </div>
        {% endif %}

        <div class="form-group">
            <label><i class="fas fa-calendar-day"></i> Fecha de Vencimiento</label>
            <div style="padding: 0.8rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                <i class="fas fa-clock"></i> {{ task.due_date.strftime('%d/%m/%Y a las %H:%M') }}
            </div>
        </div>
    </div>

    <div class="form-group">
        <label><i class="fas fa-users"></i> Asignado a</label>
        <div style="padding: 0.8rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
            {% if task.assignees %}
            {% for user in task.assignees %}
            <span
                style="display: inline-block; background: #e5e7eb; padding: 0.2rem 0.6rem; border-radius: 15px; margin-right: 0.5rem; font-size: 0.9rem;">
                <i class="fas fa-user"></i> {{ user.full_name }}
            </span>
            {% endfor %}
            {% else %}
            <span style="color: var(--text-light);">Sin asignados</span>
            {% endif %}
        </div>
    </div>

    <div class="form-group">
        <label><i class="fas fa-tags"></i> Etiquetas</label>
        <div style="padding: 0.8rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
            {% if task.tags %}
            {% for tag in task.tags %}
            <span class="tag-chip" style="background: {{ tag.color }};">{{ tag.name }}</span>
            {% endfor %}
            {% else %}
            <span style="color: var(--text-light);">Sin etiquetas</span>
            {% endif %}
        </div>
    </div>

    <!-- üîó Task Hierarchy Section -->
    {% if task.parent or task.children %}
    <div class="form-group"
        style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 1.5rem; border-radius: 10px; border: 1px solid #bae6fd;">
        <label style="color: #0369a1; font-weight: 700; font-size: 1.1rem; margin-bottom: 1rem; display: block;">
            <i class="fas fa-sitemap"></i> Jerarqu√≠a de Tareas
        </label>

        {% if task.parent %}
        <div style="margin-bottom: 1.5rem;">
            <div style="font-size: 0.9rem; color: #0369a1; margin-bottom: 0.5rem; font-weight: 600;">
                <i class="fas fa-level-up-alt"></i> Tarea Padre
            </div>
            <a href="{{ url_for('main.task_details', task_id=task.parent.id) }}"
                style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: white; border: 2px solid #7dd3fc; border-radius: 8px; text-decoration: none; transition: all 0.2s;"
                onmouseover="this.style.borderColor='#0284c7'; this.style.transform='translateX(5px)';"
                onmouseout="this.style.borderColor='#7dd3fc'; this.style.transform='translateX(0)';">
                <span class="task-id"
                    style="background: #0284c7; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 700; font-size: 0.85rem;">
                    #{{ task.parent.id }}
                </span>
                <div style="flex: 1;">
                    <div style="color: #0c4a6e; font-weight: 600; margin-bottom: 0.25rem;">{{ task.parent.title }}
                    </div>
                    <div style="font-size: 0.85rem; color: #64748b;">
                        <i class="fas fa-calendar"></i> {{ task.parent.due_date.strftime('%d/%m/%Y') }}
                        <span style="margin-left: 1rem;">
                            <span class="priority-badge priority-{{ task.parent.priority|lower }}"
                                style="font-size: 0.75rem; padding: 0.2rem 0.5rem;">
                                {{ task.parent.priority }}
                            </span>
                        </span>
                    </div>
                </div>
                <i class="fas fa-arrow-right" style="color: #0284c7;"></i>
            </a>
        </div>
        {% endif %}

        {% if task.children %}
        <div>
            <div style="font-size: 0.9rem; color: #0369a1; margin-bottom: 0.5rem; font-weight: 600;">
                <i class="fas fa-level-down-alt"></i> Subtareas ({{ task.children|length }})
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                {% for child in task.children %}
                <a href="{{ url_for('main.task_details', task_id=child.id) }}"
                    style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border: 2px solid #bae6fd; border-radius: 6px; text-decoration: none; transition: all 0.2s;"
                    onmouseover="this.style.borderColor='#0284c7'; this.style.marginLeft='10px';"
                    onmouseout="this.style.borderColor='#bae6fd'; this.style.marginLeft='0';">
                    <span class="task-id"
                        style="background: #60a5fa; color: white; padding: 0.2rem 0.4rem; border-radius: 3px; font-weight: 700; font-size: 0.75rem;">
                        #{{ child.id }}
                    </span>
                    <div style="flex: 1; color: #0c4a6e; font-weight: 500; font-size: 0.95rem;">{{ child.title }}
                    </div>
                    <span class="priority-badge priority-{{ child.priority|lower }}"
                        style="font-size: 0.7rem; padding: 0.15rem 0.4rem;">
                        {{ child.priority }}
                    </span>
                    {% if child.status == 'Completed' %}
                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                    {% elif child.status == 'Anulado' %}
                    <i class="fas fa-ban" style="color: #9ca3af;"></i>
                    {% else %}
                    <i class="fas fa-clock" style="color: #f59e0b;"></i>
                    {% endif %}
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="form-group" style="margin-top: 2rem; border-top: 1px solid #e5e7eb; padding-top: 1rem;">
        <label><i class="fas fa-info"></i> Informaci√≥n Adicional</label>
        <div style="color: var(--text-light); font-size: 0.9rem;">
            <p style="margin: 0.2rem 0;"><i class="fas fa-user-edit"></i> Creado por <strong>{{
                    task.creator.full_name
                    }}</strong> el {{ (task.created_at|to_buenos_aires).strftime('%d/%m/%Y a las %H:%M') }}</p>
            {% if task.status == 'Completed' and task.completed_by %}
            <p style="margin: 0.2rem 0; color: var(--success-color);"><i class="fas fa-check"></i> Completado por
                <strong>{{ task.completed_by.full_name }}</strong> el {{
                (task.completed_at|to_buenos_aires).strftime('%d/%m/%Y a las %H:%M') }}
            </p>
            {% if task.completion_comment %}
            <div
                style="margin: 0.75rem 0; padding: 0.75rem 1rem; background: #f0fdf4; border-left: 4px solid #10b981; border-radius: 6px;">
                <label
                    style="color: #059669; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.25rem; display: block;">
                    <i class="fas fa-comment"></i> Observaci√≥n al completar:
                </label>
                <p style="margin: 0; color: #166534; white-space: pre-wrap;">{{ task.completion_comment }}</p>
            </div>
            {% endif %}
            {% elif task.status == 'Anulado' and task.completed_by %}
            <p style="margin: 0.2rem 0; color: #9ca3af;"><i class="fas fa-ban"></i> Anulado por
                <strong>{{ task.completed_by.full_name }}</strong> el {{
                (task.completed_at|to_buenos_aires).strftime('%d/%m/%Y a las %H:%M') }}
            </p>
            {% endif %}
            {% if task.enabled_at and task.enabled_by_task %}
            <p style="margin: 0.2rem 0; color: #8b5cf6;"><i class="fas fa-unlock"></i> Habilitada el {{
                (task.enabled_at|to_buenos_aires).strftime('%d/%m/%Y a las %H:%M') }} al completarse la tarea
                <a href="{{ url_for('main.task_details', task_id=task.enabled_by_task.id) }}"
                    style="color: #6366f1; font-weight: 600;">#{{ task.enabled_by_task.id }} - {{
                    task.enabled_by_task.title }}</a>
            </p>
            {% endif %}
            {% if task.original_due_date %}
            <p style="margin: 0.2rem 0; color: #f59e0b;"><i class="fas fa-calendar-alt"></i>
                <strong>Fecha ajustada:</strong> La fecha de vencimiento original era
                <span style="text-decoration: line-through;">{{ task.original_due_date.strftime('%d/%m/%Y')
                    }}</span>
                ‚Üí cambi√≥ a <strong>{{ task.due_date.strftime('%d/%m/%Y') }}</strong>
                porque la tarea padre se complet√≥ despu√©s de la fecha original.
            </p>
            {% endif %}
        </div>
    </div>

    <!-- Status Timeline History -->
    <div class="form-group"
        style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 1.5rem; border-radius: 10px; border: 1px solid #e2e8f0;">
        <label style="color: #475569; font-weight: 700; font-size: 1.1rem; margin-bottom: 1rem; display: block;">
            <i class="fas fa-history"></i> Historial de Estados
        </label>
        <div style="position: relative; padding-left: 25px;">
            <!-- Timeline line -->
            <div style="position: absolute; left: 8px; top: 5px; bottom: 5px; width: 2px; background: #e2e8f0;">
            </div>

            <!-- Created -->
            <div style="position: relative; margin-bottom: 1rem;">
                <div
                    style="position: absolute; left: -21px; width: 14px; height: 14px; border-radius: 50%; background: #6366f1; border: 2px solid white;">
                </div>
                <p style="margin: 0; color: #6366f1; font-weight: 600;">
                    <i class="fas fa-plus-circle"></i> Tarea creada
                </p>
                <p style="margin: 0.2rem 0 0; color: #64748b; font-size: 0.9rem;">
                    {{ (task.created_at|to_buenos_aires).strftime('%d/%m/%Y a las %H:%M') }}
                    por <strong>{{ task.creator.full_name }}</strong>
                </p>
            </div>

            <!-- Dynamic Status History -->
            <!-- Timeline Events -->
            {% for event in timeline_events %}
            <div style="position: relative; margin-bottom: 1.5rem;">
                {% set color = '#64748b' %}
                {% set icon = event.icon or 'fa-circle' %}
                {% set label = event.label %}

                {% if event.type == 'status' %}
                {% if event.status_label == 'In Progress' %}
                {% set color = '#3b82f6' %}
                {% set label = 'En Proceso' %}
                {% elif event.status_label == 'In Review' %}
                {% set color = '#f59e0b' %}
                {% set label = 'En Revisi√≥n' %}
                {% elif event.status_label == 'Completed' %}
                {% set color = '#10b981' %}
                {% set label = 'Completada' %}
                {% elif event.status_label == 'Pending' %}
                {% set color = '#94a3b8' %}
                {% set label = 'Pendiente' %}
                {% endif %}
                {% elif event.type == 'edit' %}
                {% set color = '#8b5cf6' %} <!-- Purple for edits -->
                {% elif event.type == 'creation' %}
                {% set color = '#10b981' %} <!-- Green for creation -->
                {% endif %}

                <!-- Time Line Connector (visual) -->
                {% if not loop.last %}
                <div
                    style="position: absolute; left: -15px; top: 15px; bottom: -24px; border-left: 2px solid #e2e8f0; z-index: 0;">
                </div>
                {% endif %}

                <!-- Dot -->
                <div
                    style="position: absolute; left: -21px; width: 14px; height: 14px; border-radius: 50%; background: {{ color }}; border: 2px solid white; z-index: 1;">
                </div>

                <!-- Content -->
                <p
                    style="margin: 0; color: {{ color }}; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas {{ icon }}"></i> {{ label }}
                </p>

                <p style="margin: 0.2rem 0 0; color: #64748b; font-size: 0.85rem;">
                    {{ (event.timestamp|to_buenos_aires).strftime('%d/%m/%Y a las %H:%M') }}
                    por <strong>{{ event.user.full_name }}</strong>
                </p>

                <!-- Comment (Status or Edit) -->
                {% if event.comment %}
                <p
                    style="margin: 0.5rem 0 0; color: #475569; font-style: italic; font-size: 0.9rem; background: #f8fafc; padding: 0.5rem; border-radius: 6px; border-left: 3px solid {{ color }};">
                    <i class="fas fa-comment-dots" style="color: #94a3b8; margin-right: 0.3rem;"></i> "{{ event.comment
                    }}"
                </p>
                {% endif %}

                <!-- Edit Changes -->
                {% if event.type == 'edit' and event.changes %}
                <div
                    style="margin-top: 0.5rem; background: #f1f5f9; border-radius: 6px; padding: 0.5rem; font-size: 0.85rem; color: #334155;">
                    <ul style="margin: 0; padding-left: 1.2rem; list-style-type: disc;">
                        {% for change in event.changes %}
                        <li>{{ change }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endfor %}
            <!-- Completed (if applicable, shown as last state if not in history yet) -->
            {% if task.status == 'Completed' and task.status_history|length == 0 %}
            <div style="position: relative;">
                <div
                    style="position: absolute; left: -21px; width: 14px; height: 14px; border-radius: 50%; background: #10b981; border: 2px solid white;">
                </div>
                <p style="margin: 0; color: #10b981; font-weight: 600;">
                    <i class="fas fa-check-circle"></i> Completada
                </p>
                <p style="margin: 0.2rem 0 0; color: #64748b; font-size: 0.9rem;">
                    {{ (task.completed_at|to_buenos_aires).strftime('%d/%m/%Y a las %H:%M') }}
                    {% if task.completed_by %}por <strong>{{ task.completed_by.full_name }}</strong>{% endif %}
                </p>
            </div>
            {% endif %}

            <!-- Anulado (if applicable) -->
            {% if task.status == 'Anulado' %}
            <div style="position: relative;">
                <div
                    style="position: absolute; left: -21px; width: 14px; height: 14px; border-radius: 50%; background: #9ca3af; border: 2px solid white;">
                </div>
                <p style="margin: 0; color: #9ca3af; font-weight: 600;">
                    <i class="fas fa-ban"></i> Anulada
                </p>
                {% if task.completed_at %}
                <p style="margin: 0.2rem 0 0; color: #64748b; font-size: 0.9rem;">
                    {{ (task.completed_at|to_buenos_aires).strftime('%d/%m/%Y a las %H:%M') }}
                    {% if task.completed_by %}por <strong>{{ task.completed_by.full_name }}</strong>{% endif %}
                </p>
                {% endif %}
            </div>
            {% endif %}

        </div>
    </div>

    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
        <a href="{{ url_for('main.dashboard') }}"
            style="padding: 0.9rem 2rem; text-decoration: none; color: var(--text-light); font-weight: 600; border-radius: 10px; border: 2px solid var(--border-color); transition: var(--transition);">
            <i class="fas fa-arrow-left"></i> Volver al Tablero
        </a>
    </div>
</div>

<script>
    function updateStatus(taskId, newStatus) {
        let statusLabel = newStatus;
        if (newStatus === 'In Progress') statusLabel = 'En Proceso';
        else if (newStatus === 'In Review') statusLabel = 'En Revisi√≥n';
        else if (newStatus === 'Completed') statusLabel = 'Completado';
        else if (newStatus === 'Pending') statusLabel = 'Pendiente';

        Swal.fire({
            title: `Cambiar a ${statusLabel}`,
            text: "¬øDeseas agregar un comentario a este cambio de estado?",
            input: 'textarea',
            inputPlaceholder: 'Escribe un comentario opcional...',
            showCancelButton: true,
            confirmButtonText: 'Confirmar cambio',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                // User confirmed, send request with comment (even if empty)
                const comment = result.value;

                fetch(`/task/${taskId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: newStatus,
                        comment: comment
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            Swal.fire('Error', data.error || 'No se pudo actualizar el estado', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'Ocurri√≥ un error inesperado', 'error');
                    });
            }
        });
    }

    function toggleTask(taskId) {
        fetch(`/task/${taskId}/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error al actualizar la tarea: ' + (data.error || 'Desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            });
    }

    function anularTask(taskId) {
        if (!confirm('¬øEst√°s seguro de que deseas anular esta tarea? Las tareas anuladas no aparecer√°n en los informes.')) {
            return;
        }
        fetch(`/task/${taskId}/anular`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error al anular la tarea: ' + (data.error || 'Desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            });
    }
</script>
{% endblock %}