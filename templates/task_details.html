{% extends "base.html" %}

{% block content %}
<div class="card" style="max-width: 900px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
        <div>
            <h2 style="margin-bottom: 0.5rem;"><i class="fas fa-info-circle"></i> Detalles de la Tarea</h2>
            {% if task.last_edited_by %}
            <p style="color: var(--text-light); font-size: 0.9rem; margin: 0;">
                <i class="fas fa-history"></i> √öltima edici√≥n por <strong>{{ task.last_edited_by.full_name }}</strong>
                el {{ (task.last_edited_at|to_buenos_aires).strftime('%d/%m/%Y a las %H:%M') }}
            </p>
            {% endif %}
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            {% if task.status != 'Anulado' %}
            {% if task.status == 'Completed' %}
            <span class="button"
                style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); cursor: default;">
                <i class="fas fa-check-circle"></i> Completada
            </span>
            {% else %}
            <button onclick="toggleTask({{ task.id }})" class="button"
                style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <i class="fas fa-check"></i> Marcar Completada
            </button>
            {% endif %}
            <a href="{{ url_for('main.edit_task', task_id=task.id) }}" class="button">
                <i class="fas fa-edit"></i> Editar Tarea
            </a>
            <button onclick="anularTask({{ task.id }})" class="button" style="background-color: #dc2626;">
                <i class="fas fa-ban"></i> Anular
            </button>
            {% else %}
            <span class="button" style="background-color: #9ca3af; cursor: not-allowed;">
                <i class="fas fa-ban"></i> Tarea Anulada
            </span>
            {% endif %}
        </div>
    </div>

    <div class="form-group">
        <label><i class="fas fa-heading"></i> T√≠tulo</label>
        <div
            style="padding: 0.8rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 1.1rem; font-weight: 500; {% if task.status == 'Anulado' %}text-decoration: line-through; color: #9ca3af;{% endif %}">
            {{ task.title }}
        </div>
    </div>

    <div class="form-group">
        <label><i class="fas fa-align-left"></i> Descripci√≥n</label>
        <div
            style="padding: 0.8rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; min-height: 100px; white-space: pre-wrap;">
            {{ task.description or 'Sin descripci√≥n' }}</div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
        <div class="form-group">
            <label><i class="fas fa-exclamation-circle"></i> Prioridad</label>
            <div style="padding: 0.8rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                <span class="priority-badge priority-{{ task.priority|lower }}">{{ task.priority }}</span>
            </div>
        </div>

        <div class="form-group">
            <label><i class="fas fa-tasks"></i> Estado</label>
            <div style="padding: 0.8rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                {% if task.status == 'Completed' %}
                <span style="color: var(--success-color); font-weight: 600;"><i class="fas fa-check-circle"></i>
                    Completado</span>
                {% elif task.status == 'Anulado' %}
                <span style="color: #9ca3af; font-weight: 600;"><i class="fas fa-ban"></i>
                    Anulado</span>
                {% else %}
                <span style="color: var(--warning-color); font-weight: 600;"><i class="fas fa-clock"></i>
                    Pendiente</span>
                {% endif %}
            </div>
        </div>

        <div class="form-group">
            <label><i class="fas fa-calendar-day"></i> Fecha de Vencimiento</label>
            <div style="padding: 0.8rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                {{ task.due_date.strftime('%d/%m/%Y') }}
            </div>
        </div>
    </div>

    <div class="form-group">
        <label><i class="fas fa-users"></i> Asignado a</label>
        <div style="padding: 0.8rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
            {% if task.assignees %}
            {% for user in task.assignees %}
            <span
                style="display: inline-block; background: #e5e7eb; padding: 0.2rem 0.6rem; border-radius: 15px; margin-right: 0.5rem; font-size: 0.9rem;">
                <i class="fas fa-user"></i> {{ user.full_name }}
            </span>
            {% endfor %}
            {% else %}
            <span style="color: var(--text-light);">Sin asignados</span>
            {% endif %}
        </div>
    </div>

    <div class="form-group">
        <label><i class="fas fa-tags"></i> Etiquetas</label>
        <div style="padding: 0.8rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
            {% if task.tags %}
            {% for tag in task.tags %}
            <span class="tag-chip" style="background: {{ tag.color }};">{{ tag.name }}</span>
            {% endfor %}
            {% else %}
            <span style="color: var(--text-light);">Sin etiquetas</span>
            {% endif %}
        </div>
    </div>

    <!-- üîó Task Hierarchy Section -->
    {% if task.parent or task.children %}
    <div class="form-group"
        style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 1.5rem; border-radius: 10px; border: 1px solid #bae6fd;">
        <label style="color: #0369a1; font-weight: 700; font-size: 1.1rem; margin-bottom: 1rem; display: block;">
            <i class="fas fa-sitemap"></i> Jerarqu√≠a de Tareas
        </label>

        {% if task.parent %}
        <div style="margin-bottom: 1.5rem;">
            <div style="font-size: 0.9rem; color: #0369a1; margin-bottom: 0.5rem; font-weight: 600;">
                <i class="fas fa-level-up-alt"></i> Tarea Padre
            </div>
            <a href="{{ url_for('main.task_details', task_id=task.parent.id) }}"
                style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: white; border: 2px solid #7dd3fc; border-radius: 8px; text-decoration: none; transition: all 0.2s;"
                onmouseover="this.style.borderColor='#0284c7'; this.style.transform='translateX(5px)';"
                onmouseout="this.style.borderColor='#7dd3fc'; this.style.transform='translateX(0)';">
                <span class="task-id"
                    style="background: #0284c7; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 700; font-size: 0.85rem;">
                    #{{ task.parent.id }}
                </span>
                <div style="flex: 1;">
                    <div style="color: #0c4a6e; font-weight: 600; margin-bottom: 0.25rem;">{{ task.parent.title }}</div>
                    <div style="font-size: 0.85rem; color: #64748b;">
                        <i class="fas fa-calendar"></i> {{ task.parent.due_date.strftime('%d/%m/%Y') }}
                        <span style="margin-left: 1rem;">
                            <span class="priority-badge priority-{{ task.parent.priority|lower }}"
                                style="font-size: 0.75rem; padding: 0.2rem 0.5rem;">
                                {{ task.parent.priority }}
                            </span>
                        </span>
                    </div>
                </div>
                <i class="fas fa-arrow-right" style="color: #0284c7;"></i>
            </a>
        </div>
        {% endif %}

        {% if task.children %}
        <div>
            <div style="font-size: 0.9rem; color: #0369a1; margin-bottom: 0.5rem; font-weight: 600;">
                <i class="fas fa-level-down-alt"></i> Subtareas ({{ task.children|length }})
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                {% for child in task.children %}
                <a href="{{ url_for('main.task_details', task_id=child.id) }}"
                    style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border: 2px solid #bae6fd; border-radius: 6px; text-decoration: none; transition: all 0.2s;"
                    onmouseover="this.style.borderColor='#0284c7'; this.style.marginLeft='10px';"
                    onmouseout="this.style.borderColor='#bae6fd'; this.style.marginLeft='0';">
                    <span class="task-id"
                        style="background: #60a5fa; color: white; padding: 0.2rem 0.4rem; border-radius: 3px; font-weight: 700; font-size: 0.75rem;">
                        #{{ child.id }}
                    </span>
                    <div style="flex: 1; color: #0c4a6e; font-weight: 500; font-size: 0.95rem;">{{ child.title }}</div>
                    <span class="priority-badge priority-{{ child.priority|lower }}"
                        style="font-size: 0.7rem; padding: 0.15rem 0.4rem;">
                        {{ child.priority }}
                    </span>
                    {% if child.status == 'Completed' %}
                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                    {% elif child.status == 'Anulado' %}
                    <i class="fas fa-ban" style="color: #9ca3af;"></i>
                    {% else %}
                    <i class="fas fa-clock" style="color: #f59e0b;"></i>
                    {% endif %}
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="form-group" style="margin-top: 2rem; border-top: 1px solid #e5e7eb; padding-top: 1rem;">
        <label><i class="fas fa-info"></i> Informaci√≥n Adicional</label>
        <div style="color: var(--text-light); font-size: 0.9rem;">
            <p style="margin: 0.2rem 0;"><i class="fas fa-user-edit"></i> Creado por <strong>{{ task.creator.full_name
                    }}</strong> el {{ (task.created_at|to_buenos_aires).strftime('%d/%m/%Y a las %H:%M') }}</p>
            {% if task.status == 'Completed' and task.completed_by %}
            <p style="margin: 0.2rem 0; color: var(--success-color);"><i class="fas fa-check"></i> Completado por
                <strong>{{ task.completed_by.full_name }}</strong> el {{
                (task.completed_at|to_buenos_aires).strftime('%d/%m/%Y a las %H:%M') }}
            </p>
            {% elif task.status == 'Anulado' and task.completed_by %}
            <p style="margin: 0.2rem 0; color: #9ca3af;"><i class="fas fa-ban"></i> Anulado por
                <strong>{{ task.completed_by.full_name }}</strong> el {{
                (task.completed_at|to_buenos_aires).strftime('%d/%m/%Y a las %H:%M') }}
            </p>
            {% endif %}
            {% if task.enabled_at and task.enabled_by_task %}
            <p style="margin: 0.2rem 0; color: #8b5cf6;"><i class="fas fa-unlock"></i> Habilitada el {{
                (task.enabled_at|to_buenos_aires).strftime('%d/%m/%Y a las %H:%M') }} al completarse la tarea
                <a href="{{ url_for('main.task_details', task_id=task.enabled_by_task.id) }}"
                    style="color: #6366f1; font-weight: 600;">#{{ task.enabled_by_task.id }} - {{
                    task.enabled_by_task.title }}</a>
            </p>
            {% endif %}
            {% if task.original_due_date %}
            <p style="margin: 0.2rem 0; color: #f59e0b;"><i class="fas fa-calendar-alt"></i>
                <strong>Fecha ajustada:</strong> La fecha de vencimiento original era
                <span style="text-decoration: line-through;">{{ task.original_due_date.strftime('%d/%m/%Y') }}</span>
                ‚Üí cambi√≥ a <strong>{{ task.due_date.strftime('%d/%m/%Y') }}</strong>
                porque la tarea padre se complet√≥ despu√©s de la fecha original.
            </p>
            {% endif %}
        </div>
    </div>

    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
        <a href="{{ url_for('main.dashboard') }}"
            style="padding: 0.9rem 2rem; text-decoration: none; color: var(--text-light); font-weight: 600; border-radius: 10px; border: 2px solid var(--border-color); transition: var(--transition);">
            <i class="fas fa-arrow-left"></i> Volver al Tablero
        </a>
    </div>
</div>

<script>
    function toggleTask(taskId) {
        fetch(`/task/${taskId}/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error al actualizar la tarea: ' + (data.error || 'Desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            });
    }

    function anularTask(taskId) {
        if (!confirm('¬øEst√°s seguro de que deseas anular esta tarea? Las tareas anuladas no aparecer√°n en los informes.')) {
            return;
        }
        fetch(`/task/${taskId}/anular`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error al anular la tarea: ' + (data.error || 'Desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            });
    }
</script>
{% endblock %}