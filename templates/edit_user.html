{% extends "base.html" %}

{% block content %}
<div class="card" style="max-width: 600px; margin: 0 auto;">
    <h2><i class="fas fa-user-edit"></i> Editar Usuario: {{ user.username }}</h2>

    <form method="POST" style="margin-top: 1.5rem;">
        <div class="form-group">
            <label for="full_name"><i class="fas fa-user"></i> Nombre Completo</label>
            <input type="text" id="full_name" name="full_name" value="{{ user.full_name }}" required>
        </div>

        <div class="form-group">
            <label for="password"><i class="fas fa-key"></i> Nueva Contraseña (dejar vacío para no cambiar)</label>
            <input type="password" id="password" name="password" placeholder="Nueva contraseña">
        </div>

        <div class="form-group">
            <label for="role"><i class="fas fa-user-tag"></i> Rol</label>
            <select id="role" name="role" onchange="handleRoleChange()"
                style="padding: 0.6rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                <option value="usuario" {% if user.role=='usuario' %}selected{% endif %}>Usuario</option>
                <option value="usuario_plus" {% if user.role=='usuario_plus' %}selected{% endif %}>Usuario con
                    Facultades (puede crear tareas)</option>
                <option value="supervisor" {% if user.role=='supervisor' %}selected{% endif %}>Supervisor (solo 1 área)
                </option>
                <option value="gerente" {% if user.role=='gerente' %}selected{% endif %}>Gerente (ve todas las áreas)
                </option>
            </select>
            <p id="singleAreaNote"
                style="{% if user.role not in ['supervisor', 'usuario_plus'] %}display: none;{% endif %} font-size: 0.8rem; color: #f59e0b; margin-top: 0.3rem;">
                <i class="fas fa-exclamation-triangle"></i> Este rol solo puede tener 1 área asignada
            </p>
            <p id="usuarioPlusNote"
                style="{% if user.role != 'usuario_plus' %}display: none;{% endif %} font-size: 0.8rem; color: #3b82f6; margin-top: 0.3rem;">
                <i class="fas fa-info-circle"></i> Puede crear tareas pero no puede ver reportes
            </p>
            <p style="font-size: 0.8rem; color: #64748b; margin-top: 0.3rem;">
                <i class="fas fa-info-circle"></i> Los gerentes pueden ver tareas de TODAS las áreas
            </p>
        </div>

        <div class="form-group">
            <label><i class="fas fa-building"></i> Áreas Asignadas</label>
            <div id="areasContainer" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                {% for area in all_areas %}
                <label
                    style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: {{ area.color }}10; border: 1px solid {{ area.color }}40; border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" name="areas" value="{{ area.id }}" class="area-checkbox" {% if area in
                        user.areas %}checked{% endif %} style="width: auto;">
                    <span style="color: {{ area.color }}; font-weight: 500;">{{ area.name }}</span>
                </label>
                {% endfor %}
            </div>
            <p style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;">
                <i class="fas fa-info-circle"></i> El usuario solo verá tareas de las áreas seleccionadas
            </p>
        </div>

        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="is_admin" {% if user.is_admin %}checked{% endif %} style="width: auto;">
                <span><i class="fas fa-shield-alt"></i> Administrador (puede crear tareas y gestionar el sistema)</span>
            </label>
        </div>

        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
            <a href="{{ url_for('admin.manage_users') }}" class="button-secondary" style="text-decoration: none;">
                <i class="fas fa-times"></i> Cancelar
            </a>
            <button type="submit" class="button">
                <i class="fas fa-save"></i> Guardar Cambios
            </button>
        </div>
    </form>
</div>

<script>
    function handleRoleChange() {
        const roleSelect = document.getElementById('role');
        const singleAreaNote = document.getElementById('singleAreaNote');
        const usuarioPlusNote = document.getElementById('usuarioPlusNote');
        const checkboxes = document.querySelectorAll('.area-checkbox');

        if (!roleSelect) return;

        const needsSingleArea = roleSelect.value === 'supervisor' || roleSelect.value === 'usuario_plus';
        const isUsuarioPlus = roleSelect.value === 'usuario_plus';

        // Show/hide notes
        if (singleAreaNote) {
            singleAreaNote.style.display = needsSingleArea ? 'block' : 'none';
        }
        if (usuarioPlusNote) {
            usuarioPlusNote.style.display = isUsuarioPlus ? 'block' : 'none';
        }

        if (needsSingleArea) {
            // Enforce only 1 area for supervisor and usuario_plus
            let checkedCount = 0;
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    checkedCount++;
                    if (checkedCount > 1) {
                        cb.checked = false;
                    }
                }
            });

            // Add listener to enforce 1 area
            checkboxes.forEach(cb => {
                cb.addEventListener('change', enforceSingleArea);
            });
        } else {
            // Remove restriction
            checkboxes.forEach(cb => {
                cb.removeEventListener('change', enforceSingleArea);
            });
        }
    }

    function enforceSingleArea(event) {
        const roleSelect = document.getElementById('role');
        const needsSingleArea = roleSelect && (roleSelect.value === 'supervisor' || roleSelect.value === 'usuario_plus');
        if (needsSingleArea && event.target.checked) {
            // Uncheck all others
            document.querySelectorAll('.area-checkbox').forEach(cb => {
                if (cb !== event.target) {
                    cb.checked = false;
                }
            });
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', handleRoleChange);
</script>
{% endblock %}