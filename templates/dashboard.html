{% extends "base.html" %}

{% block content %}
<div class="dashboard-header">
    <h1><i class="fas fa-clipboard-list"></i> Mis Tareas</h1>
    {% if current_user.can_create_tasks() %}
    <div style="display: flex; gap: 0.5rem;">
        <button onclick="document.getElementById('importModal').style.display='flex'" class="button-secondary">
            <i class="fas fa-file-import"></i> Importar Excel
        </button>
        <a href="{{ url_for('main.create_task') }}" class="button">
            <i class="fas fa-plus"></i> Nueva Tarea
        </a>
    </div>
    {% endif %}
</div>

{% if current_user.can_create_tasks() %}
<!-- Import Modal -->
<div id="importModal"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div
        style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0;"><i class="fas fa-file-excel" style="color: #10793f;"></i> Importar Tareas desde Excel
            </h2>
            <button onclick="document.getElementById('importModal').style.display='none'"
                style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light);">&times;</button>
        </div>

        <div
            style="margin-bottom: 1.5rem; padding: 1rem; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10793f;">
            <p style="margin: 0 0 0.5rem 0; font-weight: 600;"><i class="fas fa-download"></i> Paso 1: Descarga la
                plantilla</p>
            <a href="{{ url_for('main.download_import_template') }}" class="button-secondary"
                style="display: inline-flex; align-items: center; gap: 0.5rem; text-decoration: none;">
                <i class="fas fa-file-download"></i> Descargar Plantilla Excel
            </a>
        </div>

        <form action="{{ url_for('main.import_tasks') }}" method="POST" enctype="multipart/form-data">
            <div style="margin-bottom: 1rem;">
                <p style="margin: 0 0 0.5rem 0; font-weight: 600;"><i class="fas fa-upload"></i> Paso 2: Sube tu archivo
                </p>
                <input type="file" name="file" accept=".xlsx,.xls" required
                    style="width: 100%; padding: 0.8rem; border: 2px dashed #e5e7eb; border-radius: 8px; cursor: pointer;">
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" onclick="document.getElementById('importModal').style.display='none'"
                    class="button-secondary">
                    Cancelar
                </button>
                <button type="submit" class="button">
                    <i class="fas fa-upload"></i> Importar Tareas
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<form method="GET" action="{{ url_for('main.dashboard') }}">
    <div class="filters-section"
        style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1rem;">
        <div class="filters-form" style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 180px;">
                <label
                    style="display: block; font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.25rem;">Asignado
                    a</label>
                <select name="assignee" onchange="this.form.submit()"
                    style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <option value="">Todos</option>
                    {% for user in users %}
                    <option value="{{ user.id }}" {% if request.args.get('assignee')|int==user.id %}selected{% endif %}>
                        {{ user.full_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div style="flex: 1; min-width: 180px;">
                <label
                    style="display: block; font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.25rem;">Creado
                    por</label>
                <select name="creator" onchange="this.form.submit()"
                    style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <option value="">Todos</option>
                    {% for user in users %}
                    <option value="{{ user.id }}" {% if request.args.get('creator')|int==user.id %}selected{% endif %}>
                        {{ user.full_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div style="flex: 1; min-width: 140px;">
                <label
                    style="display: block; font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.25rem;">Estado</label>
                <select name="status" onchange="this.form.submit()"
                    style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <option value="">Todos (sin anulados)</option>
                    <option value="Pending" {% if request.args.get('status')=='Pending' %}selected{% endif %}>Pendiente
                    </option>
                    <option value="Scheduled" {% if request.args.get('status')=='Scheduled' %}selected{% endif %}>
                        Programada
                    </option>
                    <option value="In Progress" {% if request.args.get('status')=='In Progress' %}selected{% endif %}>En
                        Proceso
                    </option>
                    <option value="In Review" {% if request.args.get('status')=='In Review' %}selected{% endif %}>En
                        Revisi√≥n
                    </option>
                    <option value="Overdue" {% if request.args.get('status')=='Overdue' %}selected{% endif %}>Vencidas
                    </option>
                    <option value="Completed" {% if request.args.get('status')=='Completed' %}selected{% endif %}>
                        Completado</option>
                    <option value="Anulado" {% if request.args.get('status')=='Anulado' %}selected{% endif %}>Anulado
                    </option>
                </select>
            </div>

            <div style="flex: 1; min-width: 130px;">
                <label
                    style="display: block; font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.25rem;">Etiqueta</label>
                <select name="tag_filter" onchange="this.form.submit()"
                    style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <option value="">Todas</option>
                    {% for tag in all_tags %}
                    <option value="{{ tag.id }}" {% if request.args.get('tag_filter')|int==tag.id %}selected{% endif %}>
                        {{ tag.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            {% if all_areas and current_user.is_admin %}
            <!-- Area filter - Only for admins -->
            <div style="flex: 1; min-width: 130px;">
                <label
                    style="display: block; font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.25rem;">√Årea</label>
                <select name="area" onchange="this.form.submit()"
                    style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <option value="">Todas las √°reas</option>
                    {% for area in all_areas %}
                    <option value="{{ area.id }}" {% if request.args.get('area')|int==area.id %}selected{% endif %}
                        style="color: {{ area.color }};">
                        {{ area.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <div style="flex: 1; min-width: 140px;">
                <label
                    style="display: block; font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.25rem;">Per√≠odo</label>
                <select name="period" id="periodFilter"
                    onchange="if(this.value!='custom') this.form.submit(); else document.getElementById('customDatesContainer').style.display='flex';"
                    style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <option value="today" {% if filter_period=='today' %}selected{% endif %}>Hoy (+Vencidas)</option>
                    <option value="week" {% if filter_period=='week' %}selected{% endif %}>Esta Semana</option>
                    <option value="month" {% if filter_period=='month' %}selected{% endif %}>Este Mes</option>
                    <option value="custom" {% if filter_period=='custom' %}selected{% endif %}>Personalizado</option>
                    <option value="all" {% if filter_period=='all' %}selected{% endif %}>Todas</option>
                </select>
            </div>

            <div id="customDatesContainer"
                style="display: {% if filter_period == 'custom' %}flex{% else %}none{% endif %}; gap: 0.5rem; align-items: center;">
                <div>
                    <label
                        style="display: block; font-size: 0.7rem; color: var(--text-light); margin-bottom: 0.1rem;">Desde</label>
                    <input type="date" name="date_from" value="{{ filter_date_from or '' }}"
                        style="padding: 0.4rem; border: 1px solid #e5e7eb; border-radius: 6px; width: 130px;">
                </div>
                <div>
                    <label
                        style="display: block; font-size: 0.7rem; color: var(--text-light); margin-bottom: 0.1rem;">Hasta</label>
                    <input type="date" name="date_to" value="{{ filter_date_to or '' }}"
                        style="padding: 0.4rem; border: 1px solid #e5e7eb; border-radius: 6px; width: 130px;">
                </div>
            </div>

            <div style="flex: 0 0 auto; min-width: 140px;">
                <label
                    style="display: block; font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.25rem;">Ordenar</label>
                <select name="sort" onchange="this.form.submit()"
                    style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <option value="asc" {% if sort_order=='asc' %}selected{% endif %}>‚Üë M√°s pr√≥ximas</option>
                    <option value="desc" {% if sort_order=='desc' %}selected{% endif %}>‚Üì M√°s lejanas</option>
                </select>
            </div>

            <div style="display: flex; gap: 0.5rem;">
                <button type="submit" class="button"
                    style="padding: 0.5rem 1rem; height: 38px; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-filter"></i> Filtrar
                </button>
                <button type="submit" formaction="{{ url_for('main.export_pdf') }}" class="button-secondary"
                    title="Exportar a PDF"
                    style="height: 38px; width: 38px; padding: 0; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-file-pdf"></i>
                </button>
                <button type="submit" formaction="{{ url_for('main.export_excel') }}" class="button-secondary"
                    title="Exportar a Excel"
                    style="background-color: #10793f; height: 38px; width: 38px; padding: 0; display: flex; align-items: center; justify-content: center; color: white;">
                    <i class="fas fa-file-excel"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="search-section"
        style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;">
        <div style="position: relative;">
            <i class="fas fa-search"
                style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-light);"></i>
            <input type="text" name="q" placeholder="Buscar tarea por nombre o descripci√≥n..."
                value="{{ request.args.get('q', '') }}"
                style="width: 100%; padding: 0.8rem 1rem 0.8rem 2.5rem; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 1rem;">
        </div>
    </div>
</form>

<div class="tasks-grid">
    {% if tasks %}
    {% for task in tasks %}
    <div
        class="task-card {% if task.status == 'Anulado' %}anulado{% elif not task.enabled %}blocked{% elif task.status == 'Completed' %}completed{% elif task.status == 'Scheduled' %}scheduled{% elif task.status == 'In Progress' %}in-progress{% elif task.status == 'In Review' %}in-review{% elif task.due_date < now %}overdue{% elif task.due_date.date() == today %}due-today{% endif %}">
        <div class="task-card-header">
            <!-- üö´ Anulado Banner (Absolute priority) -->
            {% if task.status == 'Anulado' %}
            <div class="status-banner anulado" style="background: #9ca3af;">
                <i class="fas fa-ban"></i> Anulada
            </div>
            <!-- üîí Blocked Banner (second priority) -->
            {% elif not task.enabled %}
            <div class="status-banner blocked">
                <i class="fas fa-lock"></i> Bloqueada
                {% if task.parent %}
                <span style="font-weight: 400; margin-left: 0.5rem;">| Esperando #{{ task.parent.id }}</span>
                {% endif %}
            </div>
            <!-- üö® Alert Banners -->
            {% elif task.status == 'Pending' %}
            {% if task.due_date < now %} <div class="status-banner overdue">
                <i class="fas fa-exclamation-triangle"></i> ¬°Vencida!
        </div>
        {% elif task.due_date.date() == today %}
        <div class="status-banner due-today">
            <i class="fas fa-clock"></i> Vence Hoy
        </div>
        {% endif %}
        {% elif task.status == 'In Progress' %}
        <div class="status-banner in-progress {% if task.due_date < now %}overdue-border{% endif %}">
            <i class="fas fa-spinner"></i> En Proceso
            {% if task.due_date < now %} <span class="overdue-badge"><i class="fas fa-exclamation-triangle"></i>
                VENCIDA</span>
                {% endif %}
        </div>
        {% elif task.status == 'In Review' %}
        <div class="status-banner in-review {% if task.due_date < now %}overdue-border{% endif %}">
            <i class="fas fa-eye"></i> En Revisi√≥n
            {% if task.due_date < now %} <span class="overdue-badge"><i class="fas fa-exclamation-triangle"></i>
                VENCIDA</span>
                {% endif %}
        </div>
        {% elif task.status == 'Scheduled' %}
        <div class="status-banner scheduled">
            <i class="fas fa-calendar-alt"></i> Programada
        </div>
        {% endif %}

        <div class="header-main" {% if task.status in ['Pending', 'In Progress' , 'In Review' ] and
            (task.due_date.date() <=today or task.status !='Pending' ) %}style="margin-top: 0.75rem;" {% endif %}>
            <span class="priority-dot priority-{{ task.priority|lower }}" title="Prioridad {{ task.priority }}"></span>
            <span class="task-id">#{{ task.id }}</span>
            {% if task.parent_id %}
            <span class="parent-badge" title="Subtarea de #{{ task.parent_id }}">
                <i class="fas fa-level-up-alt"></i>
            </span>
            {% endif %}
            {% if task.recurring_task_id %}
            <span class="recurring-badge" title="Tarea recurrente">
                <i class="fas fa-sync-alt"></i>
            </span>
            {% endif %}

            <div class="action-buttons">
                {% if task.status != 'Anulado' %}
                {% if task.status == 'Completed' %}
                <span class="status-pill completed">
                    <i class="fas fa-check"></i> Completada
                </span>
                {% elif task.status == 'In Review' %}
                <button class="action-btn review-complete" onclick="updateTaskStatus({{ task.id }}, 'Completed')"
                    title="Aprobar y completar">
                    <i class="fas fa-check-circle"></i> <span>Completar</span>
                </button>
                {% elif task.status == 'In Progress' %}
                <button class="action-btn send-review" onclick="updateTaskStatus({{ task.id }}, 'In Review')"
                    title="Enviar a revisi√≥n">
                    <i class="fas fa-eye"></i> <span>Revisar</span>
                </button>
                {% else %}
                <button class="action-btn start-task" onclick="updateTaskStatus({{ task.id }}, 'In Progress')"
                    title="Iniciar tarea">
                    <i class="fas fa-play"></i> <span>Iniciar</span>
                </button>
                {% endif %}

                <div class="secondary-actions">
                    <a href="{{ url_for('main.edit_task', task_id=task.id) }}" class="icon-btn edit" title="Editar">
                        <i class="fas fa-pen"></i>
                    </a>
                    <button class="icon-btn ban" onclick="anularTask({{ task.id }})" title="Anular">
                        <i class="fas fa-ban"></i>
                    </button>
                </div>
                {% else %}
                <span class="status-badge anulado-badge">ANULADO</span>
                {% endif %}
            </div>
        </div>

        <a href="{{ url_for('main.task_details', task_id=task.id) }}" class="task-title-link">
            <h3 class="task-title">{{ task.title }}</h3>
        </a>
    </div>

    <div class="task-card-body">
        {% if task.description %}
        <p class="task-description">{{ task.description|truncate(100) }}</p>
        {% else %}
        <p class="task-description empty">Sin descripci√≥n</p>
        {% endif %}

        <div class="tags-container">
            {% if task.area %}
            <span class="area-tag" style="--area-color: {{ task.area.color }};">
                {{ task.area.name }}
            </span>
            {% endif %}
            {% for tag in task.tags %}
            <span class="tag-pill" style="--tag-color: {{ tag.color }};">
                {{ tag.name }}
            </span>
            {% endfor %}
        </div>
    </div>

    <div class="task-card-footer">
        <div class="meta-row">
            <div class="meta-item assignees"
                title="Asignado a: {% for u in task.assignees %}{{ u.full_name }}{% if not loop.last %}, {% endif %}{% endfor %}">
                <i class="fas fa-users"></i>
                <span>
                    {% if task.assignees %}
                    {{ task.assignees|length }}
                    {% else %}
                    0
                    {% endif %}
                </span>
            </div>

            {% if task.children|length > 0 %}
            {% set completed_subtasks = task.children|selectattr('status', 'equalto', 'Completed')|list|length %}
            {% set total_subtasks = task.children|length %}
            <div class="meta-item subtasks" title="{{ completed_subtasks }}/{{ total_subtasks }} subtareas completadas"
                style="display: flex; align-items: center; gap: 0.3rem; {% if completed_subtasks == total_subtasks %}color: #10b981;{% elif completed_subtasks > 0 %}color: #f59e0b;{% else %}color: #94a3b8;{% endif %}">
                <i class="fas fa-tasks"></i>
                <span style="font-weight: 600;">{{ completed_subtasks }}/{{ total_subtasks }}</span>
            </div>
            {% endif %}

            <div
                class="meta-item date {% if task.due_date.date() < today and task.status == 'Pending' %}text-danger{% elif task.due_date.date() == today and task.status == 'Pending' %}text-warning{% endif %}">
                <i class="far fa-calendar-alt"></i>
                <span>{{ task.due_date.strftime('%d/%m') }}</span>
            </div>
        </div>

        {% if task.status == 'Completed' %}
        <div class="completion-info">
            Completado por {{ task.completed_by.full_name.split()[0] }}
            {% if task.approved_by %}
            <span style="color: #0369a1;"> | Aprobado por {{ task.approved_by.full_name.split()[0] }}</span>
            {% endif %}
        </div>
        {% endif %}
    </div>

    {% if task.status == 'Completed' and task.completion_comment %}
    <div class="task-card-comment">
        <i class="fas fa-comment"></i>
        <span>{{ task.completion_comment }}</span>
    </div>
    {% endif %}
</div>
{% endfor %}
{% else %}
<div class="empty-state">
    <div class="empty-icon">
        <i class="fas fa-clipboard-check"></i>
    </div>
    <h3>No hay tareas pendientes</h3>
    <p>¬°Todo al d√≠a! Disfruta de tu tiempo libre o crea una nueva tarea.</p>
    {% if current_user.can_create_tasks() %}
    <a href="{{ url_for('main.create_task') }}" class="button">Crear Tarea</a>
    {% endif %}
</div>
{% endif %}
</div>

<style>
    /* Dashboard Grid Layout */
    .tasks-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        padding: 0.5rem 0;
    }

    /* Task Card Style */
    .task-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        transition: all 0.2s ease;
        border: 1px solid #e2e8f0;
        overflow: hidden;
        height: 100%;
        position: relative;
    }

    .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    /* Status variants - Full Color Backgrounds for Urgency */
    .task-card.overdue {
        background-color: #fef2f2;
        border: 1px solid #fecaca;
        box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.1), 0 2px 4px -1px rgba(220, 38, 38, 0.06);
    }

    .task-card.overdue .task-card-header {
        background-color: #fee2e2;
        border-bottom: 1px solid #fca5a5;
    }

    .task-card.overdue .task-title {
        color: #991b1b;
    }

    .task-card.overdue .btn-icon {
        color: #ef4444;
    }

    .task-card.overdue .btn-icon:hover {
        background: #fecaca;
        color: #b91c1c;
    }

    .task-card.due-today {
        background-color: #fffbeb;
        border: 1px solid #fde68a;
        box-shadow: 0 4px 6px -1px rgba(217, 119, 6, 0.1), 0 2px 4px -1px rgba(217, 119, 6, 0.06);
    }

    .task-card.due-today .task-card-header {
        background-color: #fef3c7;
        border-bottom: 1px solid #fcd34d;
    }

    .task-card.due-today .task-title {
        color: #92400e;
    }

    .task-card.due-today .btn-icon {
        color: #d97706;
    }

    .task-card.due-today .btn-icon:hover {
        background: #fde68a;
        color: #b45309;
    }

    /* Green style for Completed Tasks */
    .task-card.completed {
        background-color: #f0fdf4;
        border: 1px solid #bbf7d0;
        opacity: 0.9;
    }

    .task-card.completed .task-card-header {
        background-color: #dcfce7;
        border-bottom: 1px solid #86efac;
    }

    .task-card.completed .task-title {
        color: #166534;
        text-decoration: none;
    }

    .task-card.completed .btn-icon.completed {
        color: #15803d;
        background: #bbf7d0;
        cursor: not-allowed;
    }

    .task-card.anulado {
        opacity: 0.6;
        background: #f1f5f9;
        border-color: #e2e8f0;
    }

    /* Purple style for Scheduled Tasks */
    .task-card.scheduled {
        background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        border: 1px solid #c4b5fd;
    }

    .task-card.scheduled .task-card-header {
        background-color: #ede9fe;
        border-bottom: 1px solid #c4b5fd;
    }

    .task-card.scheduled .task-title {
        color: #5b21b6;
    }

    .task-card.scheduled .task-card-footer {
        background-color: #f5f3ff;
        border-top: 1px solid #c4b5fd;
    }

    /* Status Banners */
    .status-banner {
        padding: 0.4rem 1.25rem;
        font-weight: 800;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-banner.overdue {
        background: #ef4444;
        color: white;
    }

    .status-banner.due-today {
        background: #f59e0b;
        color: white;
    }

    .status-banner.scheduled {
        background: #8b5cf6;
        color: white;
    }

    /* Update Footer for Colored Cards */
    .task-card.overdue .task-card-footer {
        background-color: #fee2e2;
        border-top: 1px solid #fca5a5;
    }

    .task-card.overdue .footer-date {
        color: #991b1b !important;
    }

    .task-card.due-today .task-card-footer {
        background-color: #fef3c7;
        border-top: 1px solid #fcd34d;
    }

    .task-card.due-today .footer-date {
        color: #92400e !important;
    }

    .task-card.completed .task-card-footer {
        background-color: #dcfce7;
        border-top: 1px solid #86efac;
    }

    .task-card.completed .completion-info {
        color: #15803d;
        font-weight: 600;
    }

    /* Card Header */
    .task-card-header {
        padding: 1rem;
        background: #fff;
        border-bottom: 1px solid #f1f5f9;
    }

    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }

    .priority-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
    }

    .priority-dot.priority-urgente {
        background-color: #ef4444;
        box-shadow: 0 0 0 2px #fee2e2;
    }

    .priority-dot.priority-media {
        background-color: #f59e0b;
        box-shadow: 0 0 0 2px #fef3c7;
    }

    .priority-dot.priority-normal {
        background-color: #3b82f6;
        box-shadow: 0 0 0 2px #dbeafe;
    }

    .task-id {
        font-size: 0.75rem;
        color: #64748b;
        background: #f1f5f9;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
    }

    /* Revised Action Buttons */
    .action-buttons {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        opacity: 0;
        /* Hidden by default */
        transition: opacity 0.2s ease-in-out;
    }

    .task-card:hover .action-buttons {
        opacity: 1;
        /* Show on hover */
    }

    /* Always show on mobile/touch devices */
    @media (max-width: 768px) {
        .action-buttons {
            opacity: 1;
        }
    }

    .secondary-actions {
        display: flex;
        gap: 0.25rem;
    }

    .action-btn {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        border: 1px solid transparent;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .action-btn.complete {
        background: white;
        border-color: #cbd5e1;
        color: #475569;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .action-btn.complete:hover {
        background: #f0fdf4;
        border-color: #86efac;
        color: #166534;
    }

    .action-btn.complete i {
        font-size: 1rem;
        color: #cbd5e1;
        /* Inactive circle */
    }

    .action-btn.complete:hover i {
        color: #16a34a;
        /* Active check */
    }

    .status-pill.completed {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        background: #dcfce7;
        color: #15803d;
        font-size: 0.8rem;
        font-weight: 700;
    }

    .icon-btn {
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        background: transparent;
        border: none;
        color: #94a3b8;
        cursor: pointer;
        transition: all 0.2s;
    }

    .icon-btn:hover {
        background: #f1f5f9;
        color: #334155;
    }

    .icon-btn.edit:hover {
        background: #eff6ff;
        color: #2563eb;
    }

    .icon-btn.ban:hover {
        background: #fef2f2;
        color: #dc2626;
    }

    /* Specific Context Colors */
    .task-card.overdue .action-btn.complete:hover {
        background: #fee2e2;
        border-color: #fca5a5;
        color: #991b1b;
    }

    .task-card.overdue .action-btn.complete:hover i {
        color: #dc2626;
    }

    .task-card.due-today .action-btn.complete:hover {
        background: #fef3c7;
        border-color: #fcd34d;
        color: #92400e;
    }

    .task-card.due-today .action-btn.complete:hover i {
        color: #d97706;
    }

    .task-title-link {
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .task-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
        line-height: 1.4;
        transition: color 0.2s;
    }

    .task-title-link:hover .task-title {
        color: #2563eb;
    }

    /* Alerts inside header */
    .alert-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.75rem;
        border-radius: 6px;
        font-weight: 700;
        font-size: 0.85rem;
        margin-top: 0.4rem;
        width: 100%;
        /* Full width alert */
    }

    .alert-badge.overdue {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    .alert-badge.due-today {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
    }

    /* Card Body */
    .task-card-body {
        padding: 1rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .task-description {
        color: #475569;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .task-description.empty {
        color: #cbd5e1;
        font-style: italic;
    }

    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        margin-top: auto;
    }

    .tag-pill {
        font-size: 0.7rem;
        padding: 0.15rem 0.5rem;
        border-radius: 12px;
        background: color-mix(in srgb, var(--tag-color) 15%, white);
        color: var(--tag-color);
        font-weight: 600;
        white-space: nowrap;
    }

    .area-tag {
        font-size: 0.7rem;
        padding: 0.15rem 0.5rem;
        border-radius: 4px;
        background: color-mix(in srgb, var(--area-color) 10%, white);
        color: var(--area-color);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.02em;
    }

    /* Info Grid for Metadata */
    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-top: auto;
        font-size: 0.85rem;
        color: #64748b;
        background: rgba(255, 255, 255, 0.5);
        padding: 0.5rem;
        border-radius: 6px;
    }

    .info-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    /* Card Footer */
    .task-card-footer {
        padding: 0.75rem 1rem;
        background: #f8fafc;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .footer-date {
        font-weight: 600;
        color: #334155;
        font-size: 0.9rem;
    }

    .footer-date.text-danger {
        color: #dc2626 !important;
    }

    .footer-date.text-warning {
        color: #d97706 !important;
    }

    .completion-info {
        font-size: 0.75rem;
        color: #10b981;
        font-weight: 500;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 16px;
        border: 2px dashed #e2e8f0;
        grid-column: 1 / -1;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .empty-icon {
        width: 80px;
        height: 80px;
        background: #f1f5f9;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1.5rem;
    }

    .empty-icon i {
        font-size: 2.5rem;
        color: #94a3b8;
    }

    .empty-state h3 {
        font-size: 1.25rem;
        color: #334155;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #64748b;
        margin-bottom: 1.5rem;
    }

    @media (max-width: 640px) {
        .tasks-grid {
            grid-template-columns: 1fr;
        }

        .action-buttons {
            opacity: 1;
        }

        background: white;
        border-radius: 16px;
        border: 2px dashed #e2e8f0;
        grid-column: 1 / -1;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .empty-icon {
        width: 80px;
        height: 80px;
        background: #f1f5f9;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1.5rem;
    }

    .empty-icon i {
        font-size: 2.5rem;
        color: #94a3b8;
    }

    .empty-state h3 {
        font-size: 1.25rem;
        color: #334155;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #64748b;
        margin-bottom: 1.5rem;
    }

    @media (max-width: 640px) {
        .tasks-grid {
            grid-template-columns: 1fr;
        }

        .action-buttons {
            opacity: 1;
        }
    }
</style>
<style>
    /* Card Status Colors */
    .task-card.in-progress {
        background-color: #eff6ff !important;
        border-color: #bfdbfe;
    }

    .task-card.in-progress .task-card-header {
        background-color: #dbeafe;
        border-bottom: 1px solid #bfdbfe;
    }

    .task-card.in-progress .task-title {
        color: #1e40af;
    }

    .status-banner.in-progress {
        background: #3b82f6;
        color: white;
    }

    .task-card.in-progress .task-card-footer {
        background-color: #dbeafe;
        border-top: 1px solid #bfdbfe;
    }

    .task-card.in-review {
        background-color: #fff7ed !important;
        border-color: #fed7aa;
    }

    .task-card.in-review .task-card-header {
        background-color: #ffedd5;
        border-bottom: 1px solid #fed7aa;
    }

    .task-card.in-review .task-title {
        color: #9a3412;
    }

    .status-banner.in-review {
        background: #f97316;
        color: white;
    }

    .task-card.in-review .task-card-footer {
        background-color: #ffedd5;
        border-top: 1px solid #fed7aa;
    }

    /* Action Buttons Colors */
    .action-btn.start-task {
        background: white;
        border-color: #93c5fd;
        color: #2563eb;
    }

    .action-btn.start-task:hover {
        background: #eff6ff;
        border-color: #3b82f6;
        color: #1e40af;
    }

    .action-btn.send-review {
        background: white;
        border-color: #fdba74;
        color: #ea580c;
    }

    .action-btn.send-review:hover {
        background: #fff7ed;
        border-color: #f97316;
        color: #c2410c;
    }

    .action-btn.review-complete {
        background: white;
        border-color: #86efac;
        color: #16a34a;
    }

    .action-btn.review-complete:hover {
        background: #f0fdf4;
        border-color: #22c55e;
        color: #15803d;
    }
</style>

<script>
    function updateTaskStatus(taskId, newStatus) {
        let statusLabel = newStatus;
        if (newStatus === 'In Progress') statusLabel = 'En Proceso';
        else if (newStatus === 'In Review') statusLabel = 'En Revisi√≥n';
        else if (newStatus === 'Completed') statusLabel = 'Completado';
        else if (newStatus === 'Pending') statusLabel = 'Pendiente';

        Swal.fire({
            title: `Cambiar a ${statusLabel}`,
            text: "¬øDeseas agregar un comentario a este cambio de estado?",
            input: 'textarea',
            inputPlaceholder: 'Escribe un comentario opcional...',
            showCancelButton: true,
            confirmButtonText: 'Confirmar cambio',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                const comment = result.value;
                fetch(`/task/${taskId}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus, comment: comment })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            Swal.fire('Error', data.error || 'No se pudo actualizar el estado', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'Error de conexi√≥n', 'error');
                    });
            }
        });
    }

    function toggleTask(taskId, btn) {
        // Redirect legacy toggle to new status update
        updateTaskStatus(taskId, 'Completed');
    }

    function anularTask(taskId) {
        Swal.fire({
            title: '¬øAnular Tarea?',
            text: "Las tareas anuladas no aparecer√°n en los informes.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'S√≠, anular',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/task/${taskId}/anular`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('Anulada', 'La tarea ha sido anulada.', 'success')
                                .then(() => window.location.reload());
                        } else {
                            Swal.fire('Error', data.error || 'No se pudo anular', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'Error de conexi√≥n', 'error');
                    });
            }
        });
    }
</script>

<style>
    .toggle-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        color: var(--text-light);
        margin-right: 0.5rem;
        transition: color 0.2s;
    }

    .toggle-btn:hover {
        color: var(--primary-color);
    }

    .toggle-btn.completed {
        color: var(--success-color);
    }

    .anular-btn:hover {
        color: #dc2626;
    }

    .task-title.completed-text {
        text-decoration: line-through;
        color: var(--text-light);
    }

    .task-title.anulado-text {
        text-decoration: line-through;
        color: #9ca3af;
    }

    .task-item.anulado {
        opacity: 0.7;
        background-color: #f9fafb;
    }

    .status-badge.anulado-badge {
        background-color: #9ca3af;
        color: white;
        padding: 0.15rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 700;
        margin-left: 0.5rem;
    }

    .recurring-badge {
        color: #0ea5e9;
        margin-left: 0.5rem;
        font-size: 0.85rem;
    }

    .task-item.overdue {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-left: 4px solid #d97706;
    }

    .task-item.overdue .task-date {
        color: #92400e;
    }

    /* Completion Modal Styles */
    #completionModal {
        border: none;
        border-radius: 16px;
        padding: 0;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        background: white;
        overflow: hidden;
        box-sizing: border-box;
        margin: auto;
    }

    #completionModal::backdrop {
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
    }

    .modal-content {
        padding: 0;
        width: 100%;
        box-sizing: border-box;
    }

    .modal-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1.25rem 1.5rem;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border-bottom: 1px solid #bbf7d0;
    }

    .modal-header i {
        font-size: 1.75rem;
        color: #16a34a;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 700;
        color: #166534;
    }

    .modal-body {
        padding: 1.5rem;
        padding-bottom: 1rem;
    }

    .modal-body label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .modal-body textarea {
        width: 100%;
        max-width: 100%;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.75rem;
        font-size: 0.95rem;
        resize: vertical;
        min-height: 80px;
        font-family: inherit;
        box-sizing: border-box;
        display: block;
        margin: 0;
    }

    .modal-body textarea:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .modal-footer {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        padding: 1rem 1.5rem;
        background: #f8fafc;
        border-top: 1px solid #e2e8f0;
    }

    .modal-btn {
        padding: 0.6rem 1.25rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .modal-btn.primary {
        background: #10b981;
        color: white;
    }

    .modal-btn.primary:hover {
        background: #059669;
    }

    .modal-btn.secondary {
        background: #f1f5f9;
        color: #475569;
    }

    .modal-btn.secondary:hover {
        background: #e2e8f0;
    }

    /* Completion Comment Display */
    .completion-comment {
        font-size: 0.8rem;
        color: #166534;
        font-style: italic;
        padding: 0.4rem 0.6rem;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 6px;
        margin-top: 0.5rem;
        display: flex;
        align-items: flex-start;
        gap: 0.4rem;
        word-break: break-word;
        overflow-wrap: break-word;
        max-width: 100%;
    }

    .completion-comment i {
        color: #15803d;
        margin-top: 0.15rem;
        flex-shrink: 0;
    }

    .completion-comment span {
        line-height: 1.3;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    /* Task Card Comment - Bottom Section */
    .task-card-comment {
        padding: 0.6rem 1rem;
        background: rgba(255, 255, 255, 0.7);
        border-top: 1px dashed #86efac;
        font-size: 0.8rem;
        color: #166534;
        font-style: italic;
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        word-break: break-word;
    }

    .task-card-comment i {
        color: #15803d;
        margin-top: 0.15rem;
        flex-shrink: 0;
        font-size: 0.85rem;
    }

    .task-card-comment span {
        line-height: 1.4;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    /* Overdue indicator for In Progress / In Review tasks */
    .overdue-border {
        box-shadow: inset 0 0 0 2px #dc2626 !important;
    }

    .overdue-badge {
        background: #dc2626;
        color: white;
        padding: 0.15rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 700;
        margin-left: auto;
        animation: pulse-overdue 1.5s ease-in-out infinite;
    }

    @keyframes pulse-overdue {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    /* Card border for overdue In Progress / In Review */
    .task-card.in-progress:has(.overdue-badge),
    .task-card.in-review:has(.overdue-badge) {
        border: 2px solid #dc2626 !important;
        box-shadow: 0 0 8px rgba(220, 38, 38, 0.3);
    }

    /* Blocked Task Styles */
    .task-card.blocked {
        opacity: 0.7;
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        border: 1px dashed #94a3b8;
    }

    /* Anulated Task Styles */
    .task-card.anulado {
        opacity: 0.6;
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        filter: grayscale(100%);
    }

    .task-card.anulado .status-banner.anulado {
        background: #6b7280 !important;
    }

    .task-card.blocked:hover {
        transform: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .status-banner.blocked {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: white;
    }

    .task-card.blocked .action-buttons {
        display: none !important;
    }

    .task-card.blocked .task-title {
        color: #64748b;
    }

    .task-card.blocked .task-description {
        color: #94a3b8;
    }
</style>


{% endblock %}