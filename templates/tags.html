{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="dashboard-header">
        <h1><i class="fas fa-tags"></i> Gestión de Etiquetas</h1>
        <button onclick="showCreateTagModal()" class="button">
            <i class="fas fa-plus"></i> Nueva Etiqueta
        </button>
    </div>

    <div class="tags-grid">
        {% for tag in tags %}
        <div class="tag-card" style="border-left: 4px solid {{ tag.color }};">
            <div class="tag-card-content">
                <div class="tag-preview" style="background-color: {{ tag.color }};">
                    <span>{{ tag.name }}</span>
                </div>
                <div class="tag-info">
                    <p class="tag-usage">{{ tag.tasks.count() }} tarea(s)</p>
                </div>
            </div>
            <div class="tag-actions">
                <button onclick="editTag({{ tag.id }}, '{{ tag.name }}', '{{ tag.color }}')" class="btn-icon"
                    title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteTag({{ tag.id }}, '{{ tag.name }}')" class="btn-icon btn-danger"
                    title="Eliminar">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal for Create/Edit Tag -->
<div id="tagModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2 id="modalTitle"><i class="fas fa-tag"></i> Nueva Etiqueta</h2>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="tagName">Nombre de la etiqueta</label>
                <input type="text" id="tagName" placeholder="ej: Civil, Urgente, Facturable" required>
            </div>
            <div class="form-group">
                <label for="tagColor">Color</label>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <input type="color" id="selectedColor" value="#2563eb"
                        style="width: 50px; height: 50px; padding: 0; border: none; border-radius: 8px; cursor: pointer;">
                    <span id="colorHex" style="font-family: monospace; color: #6b7280;">#2563eb</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeTagModal()" class="button-secondary">Cancelar</button>
            <button onclick="saveTag()" class="button" id="saveTagBtn">Crear</button>
        </div>
    </div>
</div>

<script>
    let editingTagId = null;

    function showCreateTagModal() {
        editingTagId = null;
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-tag"></i> Nueva Etiqueta';
        document.getElementById('tagName').value = '';
        document.getElementById('selectedColor').value = '#2563eb';
        document.getElementById('colorHex').textContent = '#2563eb';
        document.getElementById('saveTagBtn').textContent = 'Crear';

        document.getElementById('tagModal').style.display = 'flex';
    }

    function editTag(id, name, color) {
        editingTagId = id;
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Etiqueta';
        document.getElementById('tagName').value = name;
        document.getElementById('selectedColor').value = color;
        document.getElementById('colorHex').textContent = color;
        document.getElementById('saveTagBtn').textContent = 'Guardar';

        document.getElementById('tagModal').style.display = 'flex';
    }

    function closeTagModal() {
        document.getElementById('tagModal').style.display = 'none';
    }

    function saveTag() {
        const name = document.getElementById('tagName').value.trim();
        const color = document.getElementById('selectedColor').value;

        if (!name) {
            alert('Por favor ingresa un nombre para la etiqueta');
            return;
        }

        const url = editingTagId ? `/api/tags/${editingTagId}` : '/api/tags';
        const method = editingTagId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name, color })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'Error al guardar la etiqueta');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al guardar la etiqueta');
            });
    }

    function deleteTag(id, name) {
        if (!confirm(`¿Estás seguro de eliminar la etiqueta "${name}"?`)) {
            return;
        }

        fetch(`/api/tags/${id}`, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error al eliminar la etiqueta');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar la etiqueta');
            });
    }

    // Color picker functionality
    document.getElementById('selectedColor').addEventListener('input', function (e) {
        document.getElementById('colorHex').textContent = e.target.value;
    });
</script>

<style>
    .tags-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .tag-card {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }

    .tag-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .tag-card-content {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .tag-preview {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
        align-self: flex-start;
    }

    .tag-info {
        color: #6b7280;
        font-size: 0.85rem;
    }

    .tag-usage {
        margin: 0;
    }

    .tag-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e5e7eb;
    }

    .btn-icon {
        background: none;
        border: none;
        color: #6b7280;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .btn-icon:hover {
        background: #f3f4f6;
        color: var(--primary-color);
    }

    .btn-danger:hover {
        color: #dc2626;
    }
</style>
{% endblock %}