{% extends "base.html" %}

{% block content %}
<div class="card">
    <!-- Header -->
    <div
        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div
                style="width: 56px; height: 56px; background: {{ process.process_type.color }}20; border-radius: 14px; display: flex; align-items: center; justify-content: center;">
                <i class="fas {{ process.process_type.icon }}"
                    style="font-size: 1.5rem; color: {{ process.process_type.color }};"></i>
            </div>
            <div>
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <h2 style="margin: 0;">{{ process.name }}</h2>
                    <span title="ID del Proceso (Click para copiar)" onclick="copyToClipboard('{{ process.id }}')"
                        style="background: #e2e8f0; color: #475569; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-family: monospace; cursor: pointer; border: 1px solid #cbd5e1;">
                        #{{ process.id }} <i class="fas fa-copy" style="font-size: 0.7rem;"></i>
                    </span>

                    {% if process.status == 'Active' %}
                    <span
                        style="background: #dbeafe; color: #1d4ed8; padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                        <i class="fas fa-play"></i> Activo
                    </span>
                    {% elif process.status == 'Completed' %}
                    <span
                        style="background: #dcfce7; color: #16a34a; padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                        <i class="fas fa-check-circle"></i> Completado
                    </span>
                    {% elif process.status == 'Cancelled' %}
                    <span
                        style="background: #f1f5f9; color: #64748b; padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                        <i class="fas fa-ban"></i> Cancelado
                    </span>
                    {% endif %}
                </div>
                <p style="margin: 0.25rem 0 0 0; color: var(--text-light);">
                    {{ process.process_type.name }} | {{ process.area.name }}
                </p>
            </div>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            {% if process.status != 'Cancelled' and (current_user.is_admin or current_user.role == 'supervisor') %}
            <button onclick="openTransferModal()" class="button-secondary" style="color: #6366f1;">
                <i class="fas fa-exchange-alt"></i> Pasar a otra Área
            </button>
            {% endif %}
            {% if process.status == 'Active' and (current_user.is_admin or current_user.role == 'supervisor') %}
            <button onclick="completeProcess()" class="button" style="background: #16a34a;">
                <i class="fas fa-check-circle"></i> Completar Proceso
            </button>
            <button onclick="cancelProcess()" class="button-secondary" style="color: #dc2626;">
                <i class="fas fa-times"></i> Cancelar Proceso
            </button>
            {% endif %}
            <a href="{{ url_for('main.list_processes') }}" class="button-secondary">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <!-- Stats Row -->
    <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <!-- Progress -->
        <div
            style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 1.25rem; border-radius: 12px; text-align: center; border: 1px solid #bae6fd;">
            <div style="position: relative; width: 80px; height: 80px; margin: 0 auto 0.5rem;">
                <svg style="transform: rotate(-90deg); width: 80px; height: 80px;">
                    <circle cx="40" cy="40" r="34" stroke="#e5e7eb" stroke-width="8" fill="none" />
                    <circle cx="40" cy="40" r="34" stroke="{{ process.process_type.color }}" stroke-width="8"
                        fill="none" stroke-linecap="round"
                        stroke-dasharray="{{ process.progress_percentage * 2.14 }}, 214" />
                </svg>
                <div
                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 700; font-size: 1.1rem;">
                    {{ process.progress_percentage }}%
                </div>
            </div>
            <div style="font-weight: 600; color: var(--text-color);">
                {{ process.completed_tasks_count }}/{{ process.total_tasks_count }} tareas
            </div>
        </div>

        <!-- Due Date -->
        <div
            style="background: linear-gradient(135deg, {% if process.due_date < now_utc() and process.status == 'Active' %}#fef2f2 0%, #fee2e2{% else %}#f8fafc 0%, #f1f5f9{% endif %} 100%); padding: 1.25rem; border-radius: 12px; text-align: center; border: 1px solid {% if process.due_date < now_utc() and process.status == 'Active' %}#fecaca{% else %}#e2e8f0{% endif %};">
            <i class="fas fa-calendar-alt"
                style="font-size: 1.5rem; color: {% if process.due_date < now_utc() and process.status == 'Active' %}#dc2626{% else %}#64748b{% endif %}; margin-bottom: 0.5rem;"></i>
            <div style="font-weight: 600; color: var(--text-color);">{{ process.due_date.strftime('%d/%m/%Y') }}</div>
            <div style="font-size: 0.85rem; color: var(--text-light);">{{ process.due_date.strftime('%H:%M') }} hs</div>
            <div
                style="font-size: 0.8rem; color: {% if process.due_date < now_utc() and process.status == 'Active' %}#dc2626{% else %}var(--text-light){% endif %}; margin-top: 0.25rem;">
                {% if process.due_date < now_utc() and process.status=='Active' %} <i
                    class="fas fa-exclamation-triangle"></i> Vencido
                    {% else %}
                    Fecha límite
                    {% endif %}
            </div>
        </div>

        <!-- Time Spent -->
        <div
            style="background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%); padding: 1.25rem; border-radius: 12px; text-align: center; border: 1px solid #f5d0fe;">
            <i class="fas fa-clock" style="font-size: 1.5rem; color: #a855f7; margin-bottom: 0.5rem;"></i>
            <div style="font-weight: 600; color: var(--text-color);">
                {% if process.total_time_spent >= 60 %}
                {{ (process.total_time_spent // 60) }}h {{ (process.total_time_spent % 60) }}m
                {% else %}
                {{ process.total_time_spent }} min
                {% endif %}
            </div>
            <div style="font-size: 0.85rem; color: var(--text-light);">Tiempo dedicado</div>
        </div>

        <!-- Created -->
        <div
            style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 1.25rem; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0;">
            <i class="fas fa-user" style="font-size: 1.5rem; color: #64748b; margin-bottom: 0.5rem;"></i>
            <div style="font-weight: 600; color: var(--text-color);">{{ process.created_by.full_name }}</div>
            <div style="font-size: 0.85rem; color: var(--text-light);">{{ process.created_at.strftime('%d/%m/%Y') }}
            </div>
        </div>
    </div>

    {% if process.description %}
    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
        <p style="margin: 0; color: var(--text-color);">{{ process.description }}</p>
    </div>
    {% endif %}

    <!-- Tasks Section -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 style="margin: 0;"><i class="fas fa-tasks"></i> Tareas del Proceso</h3>
        {% if process.status == 'Active' and current_user.can_create_tasks() %}
        <a href="{{ url_for('main.create_task') }}?process_id={{ process.id }}" class="button-secondary"
            style="padding: 0.5rem 1rem;">
            <i class="fas fa-plus"></i> Agregar Tarea
        </a>
        {% endif %}
    </div>

    {% if tasks %}
    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
        {% macro render_task(task, depth=0) %}
        <div class="task-row-container"
            style="margin-left: {{ depth * 2 }}rem; {% if depth > 0 %}border-left: 2px solid #e5e7eb; padding-left: 1rem;{% endif %}">
            <div class="task-row {% if not task.enabled %}blocked-task{% endif %}"
                style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: {% if not task.enabled %}#f3f4f6{% else %}white{% endif %}; border: 1px solid #e5e7eb; border-radius: 10px; transition: all 0.2s; position: relative;">

                <!-- Status Icon -->
                <div
                    style="width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
                            background: {% if not task.enabled %}#e5e7eb{% elif task.status == 'Completed' %}#dcfce7{% elif task.status == 'In Progress' %}#dbeafe{% elif task.status == 'In Review' %}#fef3c7{% elif task.status == 'Anulado' %}#f1f5f9{% else %}#f8fafc{% endif %};">
                    {% if not task.enabled %}
                    <i class="fas fa-lock" style="color: #6b7280;" title="Bloqueado por tarea padre"></i>
                    {% elif task.status == 'Completed' %}
                    <i class="fas fa-check" style="color: #16a34a;"></i>
                    {% elif task.status == 'In Progress' %}
                    <i class="fas fa-play" style="color: #2563eb;"></i>
                    {% elif task.status == 'In Review' %}
                    <i class="fas fa-eye" style="color: #d97706;"></i>
                    {% elif task.status == 'Anulado' %}
                    <i class="fas fa-ban" style="color: #94a3b8;"></i>
                    {% else %}
                    <i class="fas fa-clock" style="color: #94a3b8;"></i>
                    {% endif %}
                </div>

                <!-- Task Info -->
                <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <a href="{{ url_for('main.task_details', task_id=task.id) }}"
                            style="text-decoration: none; color: {% if not task.enabled %}#6b7280{% else %}var(--text-color){% endif %}; font-weight: 500;">
                            #{{ task.id }} - {{ task.title }}
                        </a>
                        {% if not task.enabled and task.parent_id %}
                        <span
                            style="font-size: 0.7rem; background: #fee2e2; color: #991b1b; padding: 0.1rem 0.4rem; border-radius: 4px;">
                            <i class="fas fa-lock"></i> Esperando #{{ task.parent_id }}
                        </span>
                        {% endif %}
                    </div>
                    <div
                        style="display: flex; gap: 1rem; font-size: 0.8rem; color: var(--text-light); margin-top: 0.25rem;">
                        <span><i class="fas fa-calendar"></i> {{ task.due_date.strftime('%d/%m %H:%M') }}</span>
                        {% if task.assignees %}
                        <span><i class="fas fa-user"></i> {{ task.assignees|map(attribute='full_name')|join(', ')
                            }}</span>
                        {% endif %}
                        {% if task.time_spent %}
                        <span><i class="fas fa-clock"></i> {{ task.time_spent }} min</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Priority Badge -->
                <span
                    style="padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600;
                            background: {% if task.priority == 'Urgente' %}#fee2e2; color: #dc2626{% elif task.priority == 'Media' %}#fef3c7; color: #d97706{% else %}#f0fdf4; color: #16a34a{% endif %};">
                    {{ task.priority }}
                </span>

                <!-- Actions -->
                <div style="display: flex; gap: 0.5rem;">
                    {% if task.status_history %}
                    <button onclick="toggleHistory({{ task.id }})" class="button-secondary"
                        style="padding: 0.4rem 0.75rem; font-size: 0.8rem;" title="Ver historial">
                        <i class="fas fa-history"></i>
                    </button>
                    {% endif %}

                    <a href="{{ url_for('main.task_details', task_id=task.id) }}" class="button-secondary"
                        style="padding: 0.4rem 0.75rem; font-size: 0.8rem;">
                        <i class="fas fa-eye"></i>
                    </a>
                </div>
            </div>

            <!-- History Section (Hidden by default) -->
            <div id="history-{{ task.id }}"
                style="display: none; background: #f8fafc; margin-top: 0.5rem; padding: 0.75rem; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 0.85rem;">
                <h6 style="margin: 0 0 0.5rem 0; color: var(--text-color);"><i class="fas fa-history"></i> Historial de
                    Cambios</h6>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    {% set status_map = {'Pending': 'Pendiente', 'In Progress': 'En Proceso', 'In Review': 'En
                    Revisión', 'Completed': 'Completado', 'Anulado': 'Anulado', 'Scheduled': 'Programado'} %}
                    {% for transition in task.status_history %}
                    <div style="display: flex; gap: 0.5rem; color: var(--text-light);">
                        <span style="font-weight: 600; min-width: 120px;">{{ transition.changed_at.strftime('%d/%m
                            %H:%M') }}</span>
                        <span>
                            <b>{{ transition.changed_by.full_name.split()[0] }}</b> cambió de
                            <span class="badge-status-sm">{{ status_map.get(transition.from_status,
                                transition.from_status) }}</span> a
                            <span class="badge-status-sm">{{ status_map.get(transition.to_status, transition.to_status)
                                }}</span>
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Recursive Children Rendering -->
        {% if task.children %}
        {% for child in task.children %}
        {{ render_task(child, depth + 1) }}
        {% endfor %}
        {% endif %}
        {% endmacro %}

        <!-- Render only root tasks (tasks without parents) -->
        {% for task in tasks %}
        {% if not task.parent_id %}
        {{ render_task(task) }}
        {% endif %}
        {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 2rem; color: var(--text-light); background: #f8fafc; border-radius: 12px;">
        <i class="fas fa-tasks" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem;"></i>
        <p style="margin: 0;">No hay tareas en este proceso.</p>
        {% if process.status == 'Active' and current_user.can_create_tasks() %}
        <a href="{{ url_for('main.create_task') }}?process_id={{ process.id }}" class="button"
            style="margin-top: 1rem;">
            <i class="fas fa-plus"></i> Agregar Tarea
        </a>
        {% endif %}
    </div>
    {% endif %}

    <!-- Completion Info -->
    {% if process.status == 'Completed' and process.completed_at %}
    <div
        style="margin-top: 2rem; padding: 1rem; background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-radius: 12px; border: 1px solid #86efac;">
        <p style="margin: 0; color: #16a34a;">
            <i class="fas fa-check-circle"></i> Proceso completado el {{ process.completed_at.strftime('%d/%m/%Y a las
            %H:%M') }} hs
        </p>
    </div>
    {% endif %}

    <!-- Transfer History -->
    <!-- General History -->
    {% if events|length > 0 %}
    <div style="margin-top: 2rem;">
        <h3 style="margin-bottom: 1rem;"><i class="fas fa-history"></i> Historial General</h3>
        <div style="background: #f8fafc; border-radius: 12px; padding: 1rem; border: 1px solid #e2e8f0;">
            {% for event in events %}
            <div
                style="display: flex; align-items: start; gap: 1rem; padding: 0.75rem 0; {% if not loop.last %}border-bottom: 1px solid #e2e8f0;{% endif %}">

                <!-- Icon based on event type -->
                <div
                    style="width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
                    background: {% if event.event_type == 'transfer' %}#dbeafe{% elif event.event_type == 'process_completed' %}#dcfce7{% elif event.event_type == 'task_completed' %}#f1f5f9{% elif event.event_type == 'task_created' %}#e0e7ff{% else %}#f1f5f9{% endif %};">

                    {% if event.event_type == 'transfer' %}
                    <i class="fas fa-exchange-alt" style="color: #2563eb; font-size: 0.9rem;"></i>
                    {% elif event.event_type == 'process_completed' %}
                    <i class="fas fa-flag-checkered" style="color: #16a34a; font-size: 0.9rem;"></i>
                    {% elif event.event_type == 'task_completed' %}
                    <i class="fas fa-check" style="color: #64748b; font-size: 0.9rem;"></i>
                    {% elif event.event_type == 'task_created' %}
                    <i class="fas fa-plus" style="color: #6366f1; font-size: 0.9rem;"></i>
                    {% else %}
                    <i class="fas fa-circle" style="color: #64748b; font-size: 0.5rem;"></i>
                    {% endif %}
                </div>

                <div style="flex: 1;">
                    <div style="font-weight: 500; font-size: 0.95rem; color: #1e293b;">
                        {{ event.description }}
                    </div>
                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">
                        {{ (event.created_at|to_buenos_aires).strftime('%d/%m/%Y %H:%M') }}
                        {% if event.user %}
                        por <strong>{{ event.user.full_name }}</strong>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Involved Areas (read-only) -->
    {% if process.involved_areas|length > 0 %}
    <div style="margin-top: 1.5rem;">
        <p style="font-size: 0.85rem; color: var(--text-light);">
            <i class="fas fa-eye"></i> Áreas con acceso de lectura:
            {% for area in process.involved_areas %}{{ area.name }}{% if not loop.last %}, {% endif %}{% endfor %}
        </p>
    </div>
    {% endif %}
</div>

<style>
    .task-row:hover {
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
    }
</style>

<!-- Transfer Modal -->
<div id="transferModal"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div
        style="background: white; border-radius: 16px; padding: 2rem; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <h3 style="margin: 0 0 1rem 0;"><i class="fas fa-exchange-alt"></i> Pasar a otra Área</h3>
        <div style="margin-bottom: 1rem;">
            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Área destino</label>
            <select id="toAreaSelect" class="form-input" style="width: 100%;">
                <option value="">Seleccionar área...</option>
                {% for area in all_areas %}
                {% if area.id != process.area_id %}
                <option value="{{ area.id }}">{{ area.name }}</option>
                {% endif %}
                {% endfor %}
            </select>
        </div>
        <div style="margin-bottom: 1.5rem;">
            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Comentario (opcional)</label>
            <textarea id="transferComment" class="form-input" style="width: 100%; min-height: 80px;"
                placeholder="Ej: Pasa a Contable para revisión de gastos"></textarea>
        </div>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button onclick="closeTransferModal()" class="button-secondary">Cancelar</button>
            <button onclick="submitTransfer()" class="button"><i class="fas fa-check"></i> Confirmar</button>
        </div>
    </div>
</div>

<script>
    function cancelProcess() {
        Swal.fire({
            title: 'Cancelar Proceso',
            text: '¿Estás seguro de que deseas cancelar este proceso? Esto anulará todas las tareas asociadas.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc2626',
            cancelButtonColor: '#64748b',
            confirmButtonText: 'Sí, cancelar',
            cancelButtonText: 'No'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/processes/{{ process.id }}/cancel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('Cancelado', 'El proceso ha sido cancelado y sus tareas anuladas.', 'success')
                                .then(() => window.location.reload());
                        } else {
                            Swal.fire('Error', data.error || 'No se pudo cancelar el proceso', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'Error de conexión', 'error');
                    });
            }
        });
    }

    function completeProcess() {
        Swal.fire({
            title: 'Completar Proceso',
            html: `
                <div style="text-align: left; font-size: 0.95rem;">
                    <p><strong>⚠️ Antes de completar, considera:</strong></p>
                    <div style="background: #fef3c7; padding: 0.75rem; border-radius: 8px; margin: 0.75rem 0; border-left: 4px solid #f59e0b;">
                        <strong>Si tu área terminó pero otras deben continuar:</strong><br>
                        Usar <strong>"Pasar a otra Área"</strong> para que el proceso siga activo.
                    </div>
                    <div style="background: #dcfce7; padding: 0.75rem; border-radius: 8px; margin: 0.75rem 0; border-left: 4px solid #16a34a;">
                        <strong>Si TODO el trabajo está finalizado:</strong><br>
                        Usar <strong>"Completar Proceso"</strong> para cerrar definitivamente.
                    </div>
                    <p style="margin-top: 1rem;">¿Estás seguro de que <u>todo el proceso</u> está terminado?</p>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#16a34a',
            cancelButtonColor: '#64748b',
            confirmButtonText: 'Sí, completar definitivamente',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/processes/{{ process.id }}/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ force: true })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('Completado', 'El proceso ha sido marcado como completado.', 'success')
                                .then(() => window.location.reload());
                        } else {
                            Swal.fire('Error', data.error || 'No se pudo completar el proceso', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'Error de conexión', 'error');
                    });
            }
        });
    }
    function toggleHistory(taskId) {
        const historyDiv = document.getElementById(`history-${taskId}`);
        if (historyDiv.style.display === 'none') {
            historyDiv.style.display = 'block';
        } else {
            historyDiv.style.display = 'none';
        }
    }

    function openTransferModal() {
        document.getElementById('transferModal').style.display = 'flex';
    }

    function closeTransferModal() {
        document.getElementById('transferModal').style.display = 'none';
    }

    function submitTransfer() {
        const toAreaId = document.getElementById('toAreaSelect').value;
        const comment = document.getElementById('transferComment').value;

        if (!toAreaId) {
            Swal.fire('Error', 'Debe seleccionar un área destino', 'error');
            return;
        }

        fetch('/processes/{{ process.id }}/transfer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ to_area_id: parseInt(toAreaId), comment: comment })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Transferido', `El proceso fue transferido de ${data.from_area} a ${data.to_area}`, 'success')
                        .then(() => window.location.reload());
                } else {
                    Swal.fire('Error', data.error || 'No se pudo transferir el proceso', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'Error de conexión', 'error');
            });
    }
</script>
{% endblock %}